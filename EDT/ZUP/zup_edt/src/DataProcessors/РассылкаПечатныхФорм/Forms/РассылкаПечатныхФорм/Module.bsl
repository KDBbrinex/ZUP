#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)

	УстановитьТипРассылаемогоДокумента(Параметры);
	ЗаполнитьВидЭлектроннойПочты();
	ЗаполнитьРассылаемыеДокументы(Параметры);
	СформироватьЗаголовокФормы();
	
	Если Не РассылкаДокументов.ДоступнаОтправкаПисем() Тогда
		ВызватьИсключение НСтр("ru = 'Отправка писем недоступна'");
	КонецЕсли;
	
	НастроитьВидимостьЭлементовФормы();
	НастроитьУсловноеОформление();
	
	ЗаполнитьУчетнуюЗапись();
	ЗаполнитьСообщение(Параметры);
	
	УстановитьВидимостьРезультатовОтправки();
	
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)

	Если ПроверятьУчетныеЗаписиПриОткрытии Тогда
		НачатьПроверкуУчетнойЗаписи();
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ОбработкаПроверкиЗаполненияНаСервере(Отказ, ПроверяемыеРеквизиты)
	
	Если Не ЗначениеЗаполнено(УчетнаяЗапись) Тогда
		ТекстСообщения = НСтр("ru = 'Не выбрана учетная запись электронной почты'");
		ОбщегоНазначения.СообщитьПользователю(ТекстСообщения, , "УчетнаяЗапись", , Отказ);
	КонецЕсли;
	
	Если Не ПолучателиЗаполнены(ЭтотОбъект) Тогда
		ТекстСообщения = НСтр("ru = 'Не заполнены получатели писем'");
		ОбщегоНазначения.СообщитьПользователю(ТекстСообщения, , "Получатели", , Отказ);
	КонецЕсли;
	
	Если ВыбранныеПечатныеФормы().Количество() = 0 Тогда
		ТекстСообщения = НСтр("ru = 'Не выбраны печатные формы'");
		ОбщегоНазначения.СообщитьПользователю(ТекстСообщения, , "ПечатныеФормы", , Отказ);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ОбработкаОповещения(ИмяСобытия, Параметр, Источник)
	
	Если ИмяСобытия = "Запись_ФизическиеЛица" Тогда
		ЗаполнитьАдресЭлектроннойПочты(Источник);
	КонецЕсли;

КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовШапкиФормы

&НаКлиенте
Процедура ВидЭлектроннойПочтыПриИзменении(Элемент)
	ВидЭлектроннойПочтыПриИзмененииНаСервере();
КонецПроцедуры

&НаКлиенте
Процедура ОтправительПредставлениеОбработкаВыбора(Элемент, ВыбранноеЗначение, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	Если УчетнаяЗапись = ВыбранноеЗначение Тогда
		Возврат;
	КонецЕсли;

	УчетнаяЗапись = ВыбранноеЗначение;
	ЗаполнитьПредставлениеОтправителя(ЭтотОбъект);
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовТаблицыФормыПолучатели

&НаКлиенте
Процедура ПолучателиВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	ПоказатьРезультатыОтправки(Элемент, Поле, ВыбраннаяСтрока, СтандартнаяОбработка);
	ОкрытьФормуПолучателя(Элемент, Поле, ВыбраннаяСтрока, СтандартнаяОбработка);
КонецПроцедуры

&НаКлиенте
Процедура ПолучателиПередНачаломДобавления(Элемент, Отказ, Копирование, Родитель, ЭтоГруппа, Параметр)
	Отказ = Истина;
КонецПроцедуры

&НаКлиенте
Процедура ПолучателиПослеУдаления(Элемент)
	УдаленыПолучатели = Истина;
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура Отправить(Команда)

	Если Не ПроверитьЗаполнение() Тогда
		Возврат;
	КонецЕсли;
	
	НачатьПредупреждениеОтправки();
	
КонецПроцедуры

&НаКлиенте
Процедура Печать(Команда)
	
	МассивОбъектов = МассивОбъектовКПечати();
	Для Каждого ПечатнаяФорма Из ВыбранныеПечатныеФормы() Цикл
		ПараметрыПечати = ПечатнаяФорма.ДополнительныеПараметры;
		Если ЗначениеЗаполнено(ПечатнаяФорма.ОбработчикПолученияДанных) Тогда
			Если Не УдаленыПолучатели Тогда
				ПараметрыПечати.Вставить("ДанныеПечати", 
					АдресДанныхПечатиБезОтбора(ПечатнаяФорма.ОбработчикПолученияДанных, МассивОбъектов));
			Иначе
				ПараметрыПечати.Вставить("ДанныеПечати", 
					АдресДанныхПечатиСОтбором(ПечатнаяФорма.ОбработчикПолученияДанных));
			КонецЕсли;
		КонецЕсли;
		УправлениеПечатьюКлиент.ВыполнитьКомандуПечати(ПечатнаяФорма.МенеджерПечати, 
			ПечатнаяФорма.Идентификатор, МассивОбъектов, ЭтотОбъект, ПараметрыПечати);
	КонецЦикла;
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаСервере
Функция МассивОбъектовКПечати()
	Возврат Получатели.Выгрузить().ВыгрузитьКолонку("РассылаемыйДокумент");
КонецФункции

&НаСервереБезКонтекста
Функция АдресДанныхПечатиБезОтбора(Обработчик, МассивОбъектов)
	Возврат ПоместитьВоВременноеХранилище(ДанныеПечатиБезОтбора(Обработчик, МассивОбъектов));
КонецФункции

&НаСервереБезКонтекста
Функция ДанныеПечатиБезОтбора(Обработчик, МассивОбъектов)
	Возврат Обработки.РассылкаПечатныхФорм.ДанныеПечатиБезОтбора(Обработчик, МассивОбъектов);
КонецФункции

&НаСервере
Функция АдресДанныхПечатиСОтбором(Обработчик)
	
	МассивОбъектов = Получатели.Выгрузить().ВыгрузитьКолонку("РассылаемыйДокумент");
	ВсеДанныеПечати = ДанныеПечатиБезОтбора(Обработчик, МассивОбъектов);
	ОбщегоНазначенияБЗК.ДобавитьИндексКоллекции(ВсеДанныеПечати, "РассылаемыйДокумент, ФизическоеЛицо");

	ДанныеПечати = Новый Массив;
	Для Каждого СтрокаДанных Из ВсеДанныеПечати Цикл
		ОтборСтрок = Новый Структура("РассылаемыйДокумент, ФизическоеЛицо");
		ЗаполнитьЗначенияСвойств(ОтборСтрок, СтрокаДанных);
		Если Получатели.НайтиСтроки(ОтборСтрок).Количество() > 0 Тогда
			ДанныеПечати.Добавить(СтрокаДанных);
		КонецЕсли;
	КонецЦикла;
	
	Возврат ПоместитьВоВременноеХранилище(ДанныеПечати);
	
КонецФункции

&НаСервере
Процедура УстановитьТипРассылаемогоДокумента(Параметры)
	
	Если Параметры.РассылаемыеДокументы = Неопределено Тогда
		ТекстСообщения = СтрШаблон(
			НСтр("ru = 'Рассылка доступна по команде из формы или списка следующих документов:
				 |%1'"),
			СтрСоединить(Метаданные.ОпределяемыеТипы.РассылаемыйДокумент.Тип.Типы(), Символы.ПС));
		ВызватьИсключение ТекстСообщения;
	КонецЕсли;

	ОбщегоНазначенияКлиентСервер.ПроверитьПараметр(Метаданные.Обработки.РассылкаПечатныхФорм.ПолноеИмя(), 
		"РассылаемыеДокументы", Параметры.РассылаемыеДокументы, Новый ОписаниеТипов("Массив"));
	
	Для Каждого ЭлементМассива Из Параметры.РассылаемыеДокументы Цикл
		ОбщегоНазначенияКлиентСервер.ПроверитьПараметр(Метаданные.Обработки.РассылкаПечатныхФорм.ПолноеИмя(), 
			"РассылаемыеДокументы", ЭлементМассива, Метаданные.ОпределяемыеТипы.РассылаемыйДокумент.Тип);
	КонецЦикла;
	
	ОбщегоНазначенияКлиентСервер.Проверить(Параметры.РассылаемыеДокументы.Количество() > 0, 
		НСтр("ru = 'Массив рассылаемых документов не заполнен'"), Метаданные.Обработки.РассылкаПечатныхФорм.ПолноеИмя());

	ТипРассылаемогоДокумента = Параметры.РассылаемыеДокументы[0];

	ЗаполнитьПечатныеФормы(Параметры);

КонецПроцедуры

&НаСервере
Процедура СформироватьЗаголовокФормы()
	
	ШаблонЗаголовка = НСтр("ru = 'Рассылка формы «%1» %2'");
	Если ВыбранныеПечатныеФормы().Количество() > 1 Тогда
		ШаблонЗаголовка = НСтр("ru = 'Рассылка %2'");
	КонецЕсли;
	
	ПредставлениеДокумента = СтрШаблон(НСтр("ru = 'документа «%1»'"), РассылаемыеДокументы[0]);
	Если РассылаемыеДокументы.Количество() > 1 Тогда
		ПредставлениеДокумента = СтрШаблон(НСтр("ru = 'документов «%1»'"), ТипЗнч(РассылаемыеДокументы[0].Значение));
	КонецЕсли;

	Заголовок = СтрШаблон(ШаблонЗаголовка, ВыбранныеПечатныеФормы()[0].Представление, ПредставлениеДокумента);
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьРассылаемыеДокументы(Параметры)
	
	ОбщегоНазначенияКлиентСервер.ДополнитьМассив(РассылаемыеДокументы, Параметры.РассылаемыеДокументы);
	Элементы.ПолучателиРассылаемыйДокумент.Видимость = РассылаемыеДокументы.Количество() > 1;
	
	ЗаполнитьПолучателей();
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьПечатныеФормы(Параметры)
	
	ПечатныеФормы.Очистить();
	Если ТипРассылаемогоДокумента = Неопределено Тогда
		Возврат;
	КонецЕсли;

	КомандыПечати = УправлениеПечатью.КомандыПечатиФормы(
		ТипРассылаемогоДокумента.Метаданные().ОсновнаяФормаОбъекта.ПолноеИмя());
	
	ОбщегоНазначенияКлиентСервер.Проверить(КомандыПечати.Количество() > 0, 
		СтрШаблон(НСтр("ru = 'У документа типа «%1» не обнаружено команд печати.'"), ТипЗнч(ТипРассылаемогоДокумента)));
	
	Если ЗначениеЗаполнено(Параметры.ПечатныеФормы) Тогда
		ЗаполнитьЗаданнымиПечатнымиФормами(Параметры.ПечатныеФормы, КомандыПечати);
		Элементы.ПечатныеФормыГруппа.Видимость = Ложь;
		Возврат;
	КонецЕсли;
	
	Для Каждого КомандаПечати Из КомандыПечати Цикл
		Если КомандаПечати.СразуНаПринтер Или КомандаПечати.СкрытаФункциональнымиОпциями Тогда
			Продолжить;
		КонецЕсли;
		ДобавитьПечатнуюФорму(КомандаПечати);
	КонецЦикла;
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьЗаданнымиПечатнымиФормами(ЗаданныеПечатныеФормы, КомандыПечати)
	
	Для Каждого ПечатнаяФорма Из РассылкаДокументов.ПечатныеФормыКомандыРассылки(ЗаданныеПечатныеФормы) Цикл
		НайденныеСтроки = КомандыПечати.НайтиСтроки(Новый Структура("Идентификатор", ПечатнаяФорма.Идентификатор));
		ОбщегоНазначенияКлиентСервер.Проверить(НайденныеСтроки.Количество() > 0, 
			СтрШаблон(НСтр("ru = 'Не найдена печатная форма %1 у документа типа «%2».
						   |Проверьте идентификаторы печатных форм, подключаемых к рассылке документов.'"),
				ПечатнаяФорма.Идентификатор, ТипЗнч(ТипРассылаемогоДокумента)), "РассылкаДокументов");
		КомандаПечати = НайденныеСтроки[0];
		ДобавитьПечатнуюФорму(КомандаПечати, ПечатнаяФорма);
	КонецЦикла;

КонецПроцедуры

&НаСервере
Процедура ДобавитьПечатнуюФорму(КомандаПечати, ДополнительноеОписание = Неопределено)

	Если КомандаПечати.СразуНаПринтер Или КомандаПечати.СкрытаФункциональнымиОпциями Тогда
		Возврат;
	КонецЕсли;

	НоваяСтрока = ПечатныеФормы.Добавить();
	ЗаполнитьЗначенияСвойств(НоваяСтрока, КомандаПечати);
	Если ДополнительноеОписание <> Неопределено Тогда
		ЗаполнитьЗначенияСвойств(НоваяСтрока, ДополнительноеОписание);
	КонецЕсли;
	НоваяСтрока.Использовать = Истина;
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьПолучателей()
	
	Получатели.Очистить();
	ЗагрузитьПолучателейИзДокументов();
	ЗаполнитьАдресаЭлектроннойПочты();
	
	ОбновитьРезультатыОтправки();
	
КонецПроцедуры

&НаСервереБезКонтекста
Процедура ЗаполнитьПредставлениеПолучателей(СтрокиПолучателей)
	
	Для Каждого СтрокаПолучателей Из СтрокиПолучателей Цикл
		СтрокаПолучателей.Представление = ПредставлениеАдресата(
			Строка(СтрокаПолучателей.ФизическоеЛицо), СтрокаПолучателей.Адрес);
	КонецЦикла;
	
КонецПроцедуры

&НаСервере
Процедура ЗагрузитьПолучателейИзДокументов()
	
	ОбщегоНазначенияКлиентСервер.Проверить(
		Метаданные.ОпределяемыеТипы.ДокументПоФизическомуЛицу.Тип.СодержитТип(ТипЗнч(ТипРассылаемогоДокумента)),
		СтрШаблон(
			НСтр("ru = 'Документ типа «%1» не подключен к составу документов, см. ОпределяемыйТип.%2.'"),
			ТипЗнч(ТипРассылаемогоДокумента), Метаданные.ОпределяемыеТипы.ДокументПоФизическомуЛицу.Имя));
	
	ФизическиеЛицаДокументы = ЗарплатаКадрыСоставДокументов.ФизическиеЛицаДокументов(РассылаемыеДокументы.ВыгрузитьЗначения());
	ФизическиеЛицаДокументы.Колонки.Документ.Имя = "РассылаемыйДокумент";
	Получатели.Загрузить(ФизическиеЛицаДокументы);
	Получатели.Сортировать("РассылаемыйДокумент, ФизическоеЛицо");
	
	ОбщегоНазначенияКлиентСервер.Проверить(Получатели.Количество() > 0, НСтр("ru = 'В документе не выбраны сотрудники.'"));
	
КонецПроцедуры

#Область ВидЭлектроннойПочты

&НаСервере
Процедура ЗаполнитьВидЭлектроннойПочты()

	ВидыЭлектроннойПочты = УправлениеКонтактнойИнформацией.ВидыКонтактнойИнформацииОбъекта(
		Справочники.ФизическиеЛица.ПустаяСсылка(), Перечисления.ТипыКонтактнойИнформации.АдресЭлектроннойПочты);
	
	Если ВидыЭлектроннойПочты.Количество() = 1 Тогда
		ВидЭлектроннойПочты = ВидыЭлектроннойПочты[0].Ссылка;
		Элементы.ВидЭлектроннойПочты.Видимость = Ложь;
		Возврат;
	КонецЕсли;
	
	Элементы.ВидЭлектроннойПочты.Видимость = Истина;
	Элементы.ВидЭлектроннойПочты.СписокВыбора.ЗагрузитьЗначения(ВидыЭлектроннойПочты.ВыгрузитьКолонку("Ссылка"));
	
	Если Элементы.ВидЭлектроннойПочты.СписокВыбора.Количество() = 0 Тогда
		ВызватьИсключение НСтр("ru = 'Рассылка невозможна, пока не существует ни одного вида электронной почты физических лиц.'");
	КонецЕсли;

	СохраненноеЗначение = ЗначениеПоТипуДокумента(ТипРассылаемогоДокумента, Элементы.ВидЭлектроннойПочты.Имя);
	Если СохраненноеЗначение = Неопределено Тогда
		СохраненноеЗначение = ЗначениеПоВсемДокументам(Элементы.ВидЭлектроннойПочты.Имя);
	КонецЕсли;
	
	Если СохраненноеЗначение <> Неопределено Тогда
		Если Элементы.ВидЭлектроннойПочты.СписокВыбора.НайтиПоЗначению(СохраненноеЗначение) <> Неопределено Тогда
			ВидЭлектроннойПочты = СохраненноеЗначение;
		КонецЕсли;
	КонецЕсли;

	Если СохраненноеЗначение = Неопределено Тогда
		ВидЭлектроннойПочты = Элементы.ВидЭлектроннойПочты.СписокВыбора[0].Значение;
	КонецЕсли;

КонецПроцедуры

&НаСервере
Процедура ВидЭлектроннойПочтыПриИзмененииНаСервере()
	
	ЗаполнитьАдресаЭлектроннойПочты();
	
	СохранитьЗначениеПоТипуДокумента(ТипРассылаемогоДокумента, Элементы.ВидЭлектроннойПочты.Имя, ВидЭлектроннойПочты);
	СохранитьЗначениеПоВсемДокументам(Элементы.ВидЭлектроннойПочты.Имя, ВидЭлектроннойПочты);
	
КонецПроцедуры

#КонецОбласти

&НаСервере
Процедура ЗаполнитьАдресЭлектроннойПочты(ФизическоеЛицо)
	
	Если Не ЗначениеЗаполнено(ФизическоеЛицо) Тогда
		Возврат;
	КонецЕсли;

	НайденныеСтроки = Получатели.НайтиСтроки(Новый Структура("ФизическоеЛицо", ФизическоеЛицо));
	Если НайденныеСтроки.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	ТаблицаКИ = АдресаЭлектроннойПочты(ОбщегоНазначенияКлиентСервер.ЗначениеВМассиве(ФизическоеЛицо), ВидЭлектроннойПочты);
	ЗаполнитьАдресаЭлектроннойПочтыВСтрокахПолучателей(НайденныеСтроки, ТаблицаКИ);

КонецПроцедуры

&НаСервере
Процедура ЗаполнитьАдресаЭлектроннойПочты()

	ТаблицаКИ = АдресаЭлектроннойПочты(
		Получатели.Выгрузить(, "ФизическоеЛицо").ВыгрузитьКолонку("ФизическоеЛицо"), ВидЭлектроннойПочты);
	
	ЗаполнитьАдресаЭлектроннойПочтыВСтрокахПолучателей(Получатели, ТаблицаКИ);
	
КонецПроцедуры

&НаСервереБезКонтекста
Функция АдресаЭлектроннойПочты(ФизическиеЛица, ВидПочты)
	
	ТаблицаКИ = УправлениеКонтактнойИнформацией.КонтактнаяИнформацияОбъектов(ФизическиеЛица, , ВидПочты);
	ОбщегоНазначенияБЗК.ДобавитьИндексКоллекции(ТаблицаКИ, "Объект");
	Возврат ТаблицаКИ;
	
КонецФункции

&НаСервереБезКонтекста
Процедура ЗаполнитьАдресаЭлектроннойПочтыВСтрокахПолучателей(СтрокиПолучателей, ТаблицаКИ)
	
	Для Каждого СтрокаТаблицы Из СтрокиПолучателей Цикл
		СтрокаТаблицы.Адрес = Неопределено;
		НайденныеСтроки = ТаблицаКИ.НайтиСтроки(Новый Структура("Объект", СтрокаТаблицы.ФизическоеЛицо));
		Если НайденныеСтроки.Количество() > 0 Тогда
			СтрокаТаблицы.Адрес = НайденныеСтроки[0].Представление;
		КонецЕсли;
	КонецЦикла;
	
	ЗаполнитьПредставлениеПолучателей(СтрокиПолучателей);
	
КонецПроцедуры

&НаКлиенте
Процедура НачатьОтправкуДокументов()

	ОчиститьРезультатыОтправки();
	
	ДлительнаяОперация = ДлительнаяОперацияОтправкиДокументов();

	ПараметрыОжидания = ДлительныеОперацииКлиент.ПараметрыОжидания(ЭтотОбъект);
	ПараметрыОжидания.ВыводитьОкноОжидания = Истина;
	ПараметрыОжидания.ВыводитьПрогрессВыполнения = Истина;
	ПараметрыОжидания.ВыводитьСообщения = Истина;
	ПараметрыОжидания.ТекстСообщения = НСтр("ru = 'Идет отправка документов'");
	ПараметрыОжидания.ОповещениеПользователя.Показать = Истина;
	ПараметрыОжидания.ОповещениеПользователя.Пояснение = НСтр("ru = 'Отправлено'");
	ПараметрыОжидания.ОповещениеПользователя.Текст = НСтр("ru = 'Отправка документов'");
	
	ОповещениеОЗавершении = Новый ОписаниеОповещения("ЗавершитьОтправкуДокументов", ЭтотОбъект);
	ДлительныеОперацииКлиент.ОжидатьЗавершение(ДлительнаяОперация, ОповещениеОЗавершении, ПараметрыОжидания);
	
КонецПроцедуры

&НаСервере
Функция ДлительнаяОперацияОтправкиДокументов()
	
	ДляОтправки = Новый Структура;
	ДляОтправки.Вставить("УчетнаяЗапись", УчетнаяЗапись);
	ДляОтправки.Вставить("ШаблонПисьма", Новый Структура("Тема, Текст", ТемаПисьма, ТекстПисьма));
	
	ДляПечати = Новый Структура;
	ДляПечати.Вставить("ПечатныеФормы", ВыбранныеПечатныеФормы());
	ДляПечати.Вставить("УпаковатьВАрхив", УпаковатьВАрхив);
	
	ПараметрыВыполнения = ДлительныеОперации.ПараметрыВыполненияВФоне(УникальныйИдентификатор);
	Возврат ДлительныеОперации.ВыполнитьФункцию(ПараметрыВыполнения,
		"Обработки." + Метаданные.Обработки.РассылкаПечатныхФорм.Имя + ".ОтправитьДокументыПолучателям", 
		Получатели.Выгрузить(), ДляПечати, ДляОтправки);
		
КонецФункции

&НаСервере
Функция ВыбранныеПечатныеФормы()
	Возврат ОбщегоНазначения.ТаблицаЗначенийВМассив(ПечатныеФормы.Выгрузить(Новый Структура("Использовать", Истина)));
КонецФункции

&НаКлиенте
Процедура ЗавершитьОтправкуДокументов(Результат, ДополнительныеПараметры) Экспорт
	
	Если Результат = Неопределено Тогда
		Возврат;
	КонецЕсли;

	Если Результат.Статус = "Ошибка" Тогда
		ВызватьИсключение Результат.КраткоеПредставлениеОшибки;
	КонецЕсли;
	
	СводныйРезультат = РезультатЗавершенияОтправкиДокументовНаСервере(Результат.АдресРезультата);
	
	СообщитьРезультатыОтправки(СводныйРезультат);
	
КонецПроцедуры

&НаКлиенте
Процедура СообщитьРезультатыОтправки(Результат)
	
	ТекстСообщения = "";
	
	Если Результат.Отправлено = 0 Тогда
		Если Результат.Обработано > 0 Тогда
			Если Результат.Обработано = 1 Тогда
				НакопитьСообщение(ТекстСообщения, НСтр("ru = 'Не удалось отправить сообщение.'"));
			Иначе
				НакопитьСообщение(ТекстСообщения, НСтр("ru = 'Не удалось отправить ни одного сообщения.'"));
			КонецЕсли;
			Если Результат.БезАдресов > 0 Тогда
				Если Результат.Ошибок = Результат.БезАдресов Тогда 
					НакопитьСообщение(ТекстСообщения, НСтр("ru = 'У получателей не заполнены адреса электронной почты.'"));
				КонецЕсли;
			КонецЕсли;
			Если Результат.Ошибок = Результат.Обработано Тогда
				НакопитьСообщение(ТекстСообщения, НСтр("ru = 'Проверьте настройки учетной записи.'"));
			КонецЕсли;
		КонецЕсли;
		ПоказатьСообщение(ТекстСообщения, НСтр("ru = 'Не отправлено'"), БиблиотекаКартинок.Предупреждение32);
		Возврат;
	КонецЕсли;
	
	Если Результат.Отправлено = Результат.Обработано - Результат.БезАдресов Тогда
		Если Результат.Отправлено = 1 Тогда
			НакопитьСообщение(ТекстСообщения, НСтр("ru = 'Сообщение успешно отправлено.'"));
		Иначе
			НакопитьСообщение(ТекстСообщения, 
				СтрШаблон(НСтр("ru = 'Все сообщения (%1) успешно отправлены.'"), Результат.Отправлено));
		КонецЕсли;
		ПоказатьСообщение(ТекстСообщения, НСтр("ru = 'Успешно отправлено'"), БиблиотекаКартинок.Успешно32);
		Возврат;
	КонецЕсли;

	НакопитьСообщение(ТекстСообщения, 
		СтрШаблон(НСтр("ru = 'Не удалось отправить %1 из %2.'"), 
			Результат.Ошибок, Результат.Обработано - Результат.БезАдресов));

	Если ОбщегоНазначенияКлиент.ПодсистемаСуществует("ЗарплатаКадрыКорпоративнаяПодсистемы.РассылкаДокументов") Тогда
		НакопитьСообщение(ТекстСообщения, 
			СтрШаблон(НСтр("ru = 'Причины отправки можно увидеть по клику на строке в колонке «%1».'"), 
				Элементы.ПолучателиДатаОтправления.Заголовок));
	КонецЕсли;

	ПоказатьСообщение(ТекстСообщения, НСтр("ru = 'Ошибки при отправке'"), БиблиотекаКартинок.Предупреждение32);
	
КонецПроцедуры

&НаКлиенте
Процедура ПоказатьСообщение(ТекстСообщения, ЗаголовокСообщения, Картинка)
	
	ПараметрыСообщения = СтандартныеПодсистемыКлиент.ПараметрыВопросаПользователю();
	ПараметрыСообщения.ПредлагатьБольшеНеЗадаватьЭтотВопрос = Ложь;
	ПараметрыСообщения.Картинка = Картинка;
	ПараметрыСообщения.Заголовок = ЗаголовокСообщения;
	
	СтандартныеПодсистемыКлиент.ПоказатьВопросПользователю(
		Неопределено, ТекстСообщения, РежимДиалогаВопрос.ОК, ПараметрыСообщения);
		
КонецПроцедуры

&НаКлиентеНаСервереБезКонтекста
Процедура НакопитьСообщение(Накопленное, Сообщение)
	
	Если Не ПустаяСтрока(Накопленное) Тогда
		Накопленное = Накопленное + Символы.ПС;
	КонецЕсли;
	
	Накопленное = Накопленное + Сообщение;
	
КонецПроцедуры

&НаСервере
Функция РезультатЗавершенияОтправкиДокументовНаСервере(АдресРезультата)
	
	Если АдресРезультата = Неопределено Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	СводныйРезультат = ПолучитьИзВременногоХранилища(АдресРезультата);
	Если СводныйРезультат = Неопределено Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	ЗаполнитьРезультатыОтправки(СводныйРезультат.Детально);
	
	Возврат СводныйРезультат;
	
КонецФункции

#Область РезультатыОтправки

&НаСервере
Процедура УстановитьВидимостьРезультатовОтправки()

	Элементы.ПолучателиДатаОтправления.Видимость = Ложь;
	Если ОбщегоНазначения.ПодсистемаСуществует("ЗарплатаКадрыКорпоративнаяПодсистемы.РассылкаДокументов") Тогда
		Элементы.ПолучателиДатаОтправления.Видимость = Истина;
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ОбновитьРезультатыОтправки()
	
	Если Не ПолучателиЗаполнены(ЭтотОбъект) Тогда
		Возврат;
	КонецЕсли;
	
	РезультатыОтправки = Неопределено;

	Если ОбщегоНазначения.ПодсистемаСуществует("ЗарплатаКадрыКорпоративнаяПодсистемы.РассылкаДокументов") Тогда
		МодульРезультатыРассылкиДокументов = ОбщегоНазначения.ОбщийМодуль("РезультатыРассылкиДокументов");
		РезультатыОтправки = МодульРезультатыРассылкиДокументов.РезультатыОтправки(Получатели.Выгрузить());
	КонецЕсли;

	ЗаполнитьРезультатыОтправки(РезультатыОтправки);
	
КонецПроцедуры

&НаСервере
Процедура ОчиститьРезультатыОтправки()

	Для Каждого СтрокаКоллекции Из Получатели Цикл
		СтрокаКоллекции.Отправлено = Неопределено;
		СтрокаКоллекции.ДатаОтправления = Неопределено;
		СтрокаКоллекции.ОписаниеОшибки = Неопределено;
		СтрокаКоллекции.КартинкаСостояния = КартинкаСостояния(СтрокаКоллекции.Отправлено);
	КонецЦикла;
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьРезультатыОтправки(РезультатыОтправки)
	
	Если РезультатыОтправки = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ОтборСтрок = Новый Структура("ФизическоеЛицо, РассылаемыйДокумент");
	Для Каждого СтрокаРезультатов Из РезультатыОтправки Цикл
		ЗаполнитьЗначенияСвойств(ОтборСтрок, СтрокаРезультатов);
		НайденныеСтроки = Получатели.НайтиСтроки(ОтборСтрок);
		Для Каждого НайденнаяСтрока Из НайденныеСтроки Цикл
			Если ТипЗнч(СтрокаРезультатов.Результат) = Тип("Булево") Тогда
				НайденнаяСтрока.Отправлено = СтрокаРезультатов.Результат;
			Иначе
				ЗаполнитьЗначенияСвойств(НайденнаяСтрока, СтрокаРезультатов.Результат);
			КонецЕсли;
			НайденнаяСтрока.КартинкаСостояния = КартинкаСостояния(НайденнаяСтрока.Отправлено);
		КонецЦикла;
	КонецЦикла;
	
КонецПроцедуры

&НаСервереБезКонтекста
Функция КартинкаСостояния(Состояние)

	Если Состояние = Истина Тогда
		Возврат БиблиотекаКартинок.ЗеленыйШар;
	ИначеЕсли Состояние = Ложь Тогда
		Возврат БиблиотекаКартинок.КрасныйШар;
	Иначе
		Возврат БиблиотекаКартинок.СерыйШар;
	КонецЕсли;
	
КонецФункции

&НаКлиенте
Процедура ПоказатьРезультатыОтправки(Элемент, Поле, ВыбраннаяСтрока, СтандартнаяОбработка)
	
	Если Поле <> Элементы.ПолучателиДатаОтправления Тогда
		Возврат;
	КонецЕсли;
	
	СтандартнаяОбработка = Ложь;

	ДанныеСтроки = Получатели.НайтиПоИдентификатору(ВыбраннаяСтрока);
	Если ДанныеСтроки = Неопределено Тогда
		Возврат;
	КонецЕсли;

	ПараметрыФормы = Новый Структура;
	ПараметрыФормы.Вставить("ФизическоеЛицо", ДанныеСтроки.ФизическоеЛицо);
	ПараметрыФормы.Вставить("Получатель", ДанныеСтроки.ФизическоеЛицо);
	ПараметрыФормы.Вставить("РассылаемыйДокумент", ДанныеСтроки.РассылаемыйДокумент);

	Если ОбщегоНазначенияКлиент.ПодсистемаСуществует("ЗарплатаКадрыКорпоративнаяПодсистемы.РассылкаДокументов") Тогда
		МодульРезультатыРассылкиДокументовКлиент = ОбщегоНазначенияКлиент.ОбщийМодуль("РезультатыРассылкиДокументовКлиент");
		МодульРезультатыРассылкиДокументовКлиент.ПоказатьРезультатыОтправки(ЭтотОбъект, ПараметрыФормы);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ОкрытьФормуПолучателя(Элемент, Поле, ВыбраннаяСтрока, СтандартнаяОбработка)
	
	Если Поле <> Элементы.ПолучателиПредставление Тогда
		Возврат;
	КонецЕсли;
	
	ДанныеСтроки = Получатели.НайтиПоИдентификатору(ВыбраннаяСтрока);
	Если ДанныеСтроки = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ЗарплатаКадрыКлиент.ОткрытьФормуФизическогоЛицаДляРедактирования(
		ДанныеСтроки.ФизическоеЛицо, "АдресЭлектроннойПочты");
	
КонецПроцедуры

#КонецОбласти

&НаКлиентеНаСервереБезКонтекста
Функция ПолучателиЗаполнены(Форма)
	Возврат Форма.Получатели.Количество() > 0;
КонецФункции

#Область УчетнаяЗапись

&НаСервере
Процедура ЗаполнитьУчетнуюЗапись()
	
	ДоступныеУчетныеЗаписи = РаботаСПочтовымиСообщениями.ДоступныеУчетныеЗаписи(Истина, , Истина);
	
	Если ДоступныеУчетныеЗаписи.Количество() = 0 Тогда
		ПроверятьУчетныеЗаписиПриОткрытии = Истина;
		Возврат;
	КонецЕсли;
	
	Если УчетнаяЗапись.Пустая() Тогда
		УчетнаяЗапись = ДоступныеУчетныеЗаписи[0].Ссылка;
	КонецЕсли;

	Элементы.ОтправительПредставление.СписокВыбора.Очистить();

	ЗначенияРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъектов(
		ДоступныеУчетныеЗаписи.ВыгрузитьКолонку("Ссылка"), "ИмяПользователя, АдресЭлектроннойПочты");

	Для Каждого СтрокаТаблицы Из ДоступныеУчетныеЗаписи Цикл
		Элементы.ОтправительПредставление.СписокВыбора.Добавить(СтрокаТаблицы.Ссылка, 
			ПредставлениеАдресата(
				ЗначенияРеквизитов[СтрокаТаблицы.Ссылка].ИмяПользователя, 
				ЗначенияРеквизитов[СтрокаТаблицы.Ссылка].АдресЭлектроннойПочты));
	КонецЦикла;

	ЗаполнитьПредставлениеОтправителя(ЭтотОбъект);

КонецПроцедуры

&НаКлиентеНаСервереБезКонтекста
Функция ПредставлениеАдресата(Имя, Адрес) Экспорт
	
	Если Имя = Адрес Или ПустаяСтрока(Имя) Тогда
		Возврат Адрес;
	КонецЕсли;
	
	Если ПустаяСтрока(Адрес) Или СтрНайти(Имя, Адрес) > 0 Тогда
		Возврат Имя;
	КонецЕсли;
	
	Возврат Имя + " <" + Адрес + ">";
	
КонецФункции

&НаКлиентеНаСервереБезКонтекста
Процедура ЗаполнитьПредставлениеОтправителя(Форма)

	ЭлементСписка = Форма.Элементы.ОтправительПредставление.СписокВыбора.НайтиПоЗначению(Форма.УчетнаяЗапись);
	Если ЭлементСписка <> Неопределено Тогда
		Форма.ОтправительПредставление = ЭлементСписка.Представление;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура НачатьПроверкуУчетнойЗаписи()
	
	РаботаСПочтовымиСообщениямиКлиент.ПроверитьНаличиеУчетнойЗаписиДляОтправкиПочты(
		Новый ОписаниеОповещения("ЗавершитьПроверкуУчетнойЗаписи", ЭтотОбъект));
	
КонецПроцедуры

&НаКлиенте
Процедура ЗавершитьПроверкуУчетнойЗаписи(Результат, ДополнительныеПараметры) Экспорт
	
	Если Результат = Истина Тогда
		ЗаполнитьУчетнуюЗапись();
		Возврат;
	КонецЕсли;
	
	ПоказатьПредупреждение(Новый ОписаниеОповещения("ЗавершитьРаботуФормы", ЭтотОбъект),
		НСтр("ru = 'Для рассылки документов требуется настроенная для отправки учетная запись электронной почты.'"));
	
КонецПроцедуры

#КонецОбласти

&НаКлиенте
Процедура ЗавершитьРаботуФормы(Результат) Экспорт
	Закрыть();
КонецПроцедуры

&НаКлиенте
Процедура НачатьПредупреждениеОтправки()

	Если ЗначениеПоТипуДокумента(ТипРассылаемогоДокумента, КлючБольшеНеЗадаватьВопросОтправки(), Ложь) Тогда
		НачатьОтправкуДокументов();
		Возврат;
	КонецЕсли;
	
	ПараметрыВопроса = СтандартныеПодсистемыКлиент.ПараметрыВопросаПользователю();
	ПараметрыВопроса.Заголовок = НСтр("ru = 'Запуск рассылки документов'");
	
	КнопкиОтвета = Новый СписокЗначений;
	КнопкиОтвета.Добавить(Истина, НСтр("ru = 'Продолжить'"));
	КнопкиОтвета.Добавить(Ложь, НСтр("ru = 'Отмена'"));
	
	СтандартныеПодсистемыКлиент.ПоказатьВопросПользователю(
		Новый ОписаниеОповещения("ЗавершитьПредупреждениеОтправки", ЭтотОбъект), 
		ТекстВопросаПредупрежденияПередОтправкой(), КнопкиОтвета, ПараметрыВопроса);
	
КонецПроцедуры

&НаКлиенте
Функция ТекстВопросаПредупрежденияПередОтправкой()
	
	ТекстВопроса = "";
	
	ВыбранныеФормы = ВыбранныеПечатныеФормы();
	Если ВыбранныеФормы.Количество() = 1 Тогда
		НакопитьСообщение(ТекстВопроса, 
			СтрШаблон(НСтр("ru = 'Форма «%1» документа «%2» будет сформирована отдельно для каждого сотрудника и направлена ему на указанный адрес электронной почты.'"), 
				ВыбранныеФормы[0].Представление, ТипЗнч(ТипРассылаемогоДокумента)));
	Иначе
		НакопитьСообщение(ТекстВопроса, 
			СтрШаблон(НСтр("ru = 'Ниже перечисленные формы документа «%1» будут сформированы отдельно для каждого сотрудника и направлены ему на указанный адрес электронной почты.'"),
			ТипЗнч(ТипРассылаемогоДокумента)));
		Для Каждого ВыбраннаяФорма Из ВыбранныеФормы Цикл
			НакопитьСообщение(ТекстВопроса, " - " + ВыбраннаяФорма.Представление);
		КонецЦикла;
	КонецЕсли;
	
	НакопитьСообщение(ТекстВопроса, 
		НСтр("ru = 'Сотрудники без адреса электронной почты будут пропущены.
			 |
			 |Процесс может занять длительное время. Продолжить?'"));
	
	Возврат ТекстВопроса;
	 
КонецФункции

&НаКлиенте
Процедура ЗавершитьПредупреждениеОтправки(Результат, ДополнительныеПараметры) Экспорт
	
	Если Результат = Неопределено Или Результат.Значение <> Истина Тогда
		Возврат;
	КонецЕсли;
	
	Если Результат.БольшеНеЗадаватьЭтотВопрос Тогда
		СохранитьЗначениеПоТипуДокумента(ТипРассылаемогоДокумента, КлючБольшеНеЗадаватьВопросОтправки(), Истина);
	КонецЕсли;
	
	НачатьОтправкуДокументов();
	
КонецПроцедуры

&НаКлиентеНаСервереБезКонтекста
Функция КлючБольшеНеЗадаватьВопросОтправки()
	Возврат "БольшеНеЗадаватьВопросОтправки";
КонецФункции

#Область ХранилищеНастроек

&НаСервереБезКонтекста
Процедура СохранитьЗначениеПоТипуДокумента(ТипДокумента, Ключ, Значение)
	ОбщегоНазначения.ХранилищеОбщихНастроекСохранить(КлючНастройкиПоТипуДокумента(ТипДокумента), Ключ, Значение);
КонецПроцедуры

&НаСервереБезКонтекста
Процедура СохранитьЗначениеПоВсемДокументам(Ключ, Значение)
	ОбщегоНазначения.ХранилищеОбщихНастроекСохранить(КлючНастройкиПоВсемДокументам(), Ключ, Значение);
КонецПроцедуры

&НаСервереБезКонтекста
Функция ЗначениеПоТипуДокумента(ТипДокумента, Ключ, ЗначениеПоУмолчанию = Неопределено)
	Возврат ОбщегоНазначения.ХранилищеОбщихНастроекЗагрузить(
		КлючНастройкиПоТипуДокумента(ТипДокумента), Ключ, ЗначениеПоУмолчанию);
КонецФункции

&НаСервереБезКонтекста
Функция ЗначениеПоВсемДокументам(Ключ, ЗначениеПоУмолчанию = Неопределено)
	Возврат ОбщегоНазначения.ХранилищеОбщихНастроекЗагрузить(
		КлючНастройкиПоВсемДокументам(), Ключ, ЗначениеПоУмолчанию);
КонецФункции

&НаСервереБезКонтекста
Функция КлючНастройкиПоТипуДокумента(ТипРассылаемогоДокумента)
	Возврат "РассылкаДокументов" + ТипРассылаемогоДокумента.Метаданные().ПолноеИмя();
КонецФункции

&НаСервереБезКонтекста
Функция КлючНастройкиПоВсемДокументам()
	Возврат "РассылкаДокументов";
КонецФункции

#КонецОбласти

&НаСервере
Процедура ЗаполнитьСообщение(Параметры)
	
	Если ЗначениеЗаполнено(Параметры.ТекстПисьма) Тогда
		ТемаПисьма = Параметры.ТемаПисьма;
		ТекстПисьма = Параметры.ТекстПисьма;
		Возврат;
	КонецЕсли;
	
	ЗаполнитьСообщениеПоУмолчанию();

КонецПроцедуры

&НаСервере
Процедура ЗаполнитьСообщениеПоУмолчанию()
	
	ТемаПисьма = НСтр("ru = 'Направляются документы'");
	// АПК:374-выкл. Восклицательный знак в тексте письма, а не в сообщении пользователю.
	// АПК:1223-выкл. Использование местоимения в тексте письма, а не в сообщении пользователю.
	ТекстПисьма = 
		НСтр("ru = 'Уважаемые сотрудники!
              |
              |Направляем вам документы.
              |Пожалуйста, распечатайте документы в двух экземплярах, поставьте свою подпись в обозначенных местах и пришлите нам фотографию или скан-копию в ответ на это письмо.
              | 
              |Администрация.'");
	// АПК:1223-вкл.
	// АПК:374-вкл.
	
КонецПроцедуры

&НаСервере
Процедура НастроитьУсловноеОформление()

	ЭлементОформления = УсловноеОформление.Элементы.Добавить();
	ЭлементОформления.Оформление.УстановитьЗначениеПараметра("ЦветТекста", ЦветаСтиля.ЦветНедоступногоТекста);
	ЭлементОформления.Поля.Элементы.Добавить().Поле = Новый ПолеКомпоновкиДанных(Элементы.ПолучателиПредставление.Имя);
	ОбщегоНазначенияКлиентСервер.УстановитьЭлементОтбора(ЭлементОформления.Отбор, 
		"Получатели.Адрес", , ВидСравненияКомпоновкиДанных.НеЗаполнено);
	
КонецПроцедуры

&НаСервере
Процедура НастроитьВидимостьЭлементовФормы()
	
	Элементы.ПолучателиДатаОтправления.Видимость = Ложь;
	
	Если ОбщегоНазначения.ПодсистемаСуществует("ЗарплатаКадрыКорпоративнаяПодсистемы.РассылкаДокументов") Тогда
		Элементы.ПолучателиДатаОтправления.Видимость = Истина;
		Элементы.Получатели.Подсказка = 
			НСтр("ru = 'Если документы ранее уже направлялись кому-то из сотрудников, дата отправления покажет, когда именно.'");
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти